<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Categories</title>
  <style>
  :root{
    --muted:#9ca3af;
    --accent:#f3f4f6;
    --yellow:#f59e0b; /* project yellow */
    --yellow-strong:#fb923c;
    --card-shadow: 0 12px 30px rgba(2,6,23,0.6);
    --background-1:#071121;
    --background-2:#0b1224;
    --card-bg: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  }

  @keyframes bgShift {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }

  body {
    font-family: Inter, system-ui, -apple-system, Roboto, Arial;
    padding: 2.5rem;
    margin: 0;
    color: var(--accent);
    background: linear-gradient(135deg, var(--background-1) 0%, var(--background-2) 50%, #081628 100%);
    background-size: 300% 300%;
    animation: bgShift 18s ease infinite;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  .container { max-width: 1100px; margin: 0 auto; }
  .top { display:flex; justify-content:space-between; align-items:center; gap:1rem }
  h1 { margin:0; font-size:1.6rem; letter-spacing:0.6px }

  button {
    padding:0.5rem 0.9rem;
    border-radius:10px;
    border:1px solid rgba(255,255,255,0.06);
    background:transparent;
    color:var(--accent);
    cursor:pointer;
    transition: transform .15s ease, box-shadow .15s ease;
  }
  button:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(2,6,23,0.45); }

  .msg { margin-top:1rem; padding:0.75rem; border-radius:10px; background: rgba(255,255,255,0.02); }
  .msg.ok { background: rgba(158,230,176,0.08); color:#9ee6b0 }
  .msg.err { background: rgba(255,20,60,0.06); color:#ffb4c6 }

  /* grid of category cards */
  .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:1.6rem; margin-top:1.4rem }
  .card {
    background: var(--card-bg);
    border-radius:14px;
    padding:1.05rem 1rem;
    box-shadow: var(--card-shadow);
    display:flex; flex-direction:column; gap:0.6rem;
    color:var(--accent);
    transform: translateY(0);
    transition: transform .28s cubic-bezier(.2,.9,.2,1), box-shadow .28s ease;
    border: 1px solid rgba(255,255,255,0.03);
  }
  .card:hover { transform: translateY(-8px) scale(1.01); box-shadow: 0 20px 40px rgba(2,6,23,0.7); }
  .card h3{ margin:0; font-size:1.08rem }
  .card .meta { color:var(--muted); font-size:0.92rem }
  .card .actions { margin-top:auto; display:flex; gap:0.5rem; justify-content:flex-end }

  .btn-primary {
    background: linear-gradient(180deg, var(--yellow) 0%, var(--yellow-strong) 100%);
    color:#071021; border:none; padding:0.5rem 0.85rem; border-radius:10px; cursor:pointer;
    box-shadow: 0 8px 18px rgba(245,158,11,0.18);
  }
  .btn-primary:hover { transform: translateY(-3px) scale(1.02); }

  .btn-selected {
    background: linear-gradient(180deg, #ffd69a, var(--yellow-strong));
    color:#071021; border:none; padding:0.48rem 0.82rem; border-radius:10px; cursor:default;
  }
  .btn-selected[disabled] { opacity:0.98 }

  .btn-ghost { background:transparent; border:1px solid rgba(255,255,255,0.06); padding:0.35rem 0.6rem; border-radius:8px }

  .badge {
    background: rgba(255,190,70,0.08);
    color: #ffd59a;
    padding:0.25rem 0.5rem;
    border-radius:999px;
    font-size:0.85rem;
    font-weight:600;
    display:inline-block;
    box-shadow: inset 0 -2px 0 rgba(0,0,0,0.08);
  }

  a.card-link{ color:inherit; text-decoration:none }
  @media (max-width:520px) { body { padding:1rem } .grid { gap:1rem } }
  </style>
</head>
<body>
  <div class="container">
    <div class="top">
      <h1>Categories</h1>
      <div>
        <button id="btnLogout" style="display:none">Logout</button>
      </div>
    </div>
    <p id="msg">Fetching categories...</p>
    <div id="list" class="grid" role="list"></div>
  </div>

  <script>
    const el = id => document.getElementById(id);
    // use cookie-based auth; allow browser to send cookies (same-origin)
    async function fetchCategories() {
      try {
        // Parallel fetch categories, user's votes and nominateds to show vote state
        const [res, votesRes, nomsRes] = await Promise.all([
          fetch('/categories', { credentials: 'same-origin' }),
          fetch('/votes', { credentials: 'same-origin' }).catch(() => ({ ok: false })),
          fetch('/nominateds', { credentials: 'same-origin' }).catch(() => ({ ok: false })),
        ]);
        if (!res.ok) {
          if (res.status === 401) {
            window.location.href = '/login/new';
            return;
          }
          const txt = await res.text();
          el('msg').textContent = 'Failed to load categories: ' + txt;
          return;
        }
        const data = await res.json();
        let votes = [];
        let noms = [];
        if (votesRes && votesRes.ok) {
          try { votes = await votesRes.json(); } catch(e) { votes = [] }
        }
        if (nomsRes && nomsRes.ok) {
          try { noms = await nomsRes.json(); } catch(e) { noms = [] }
        }
        // build maps for quick lookup
        const votedMap = {};
        votes.forEach(v => { votedMap[String(v.category_id)] = v.nominated_id });
        const nominatedById = {};
        noms.forEach(n => { nominatedById[String(n.id)] = n });
        el('msg').textContent = '';
        const list = el('list');
        list.innerHTML = '';
        if (!Array.isArray(data) || data.length === 0) {
          list.textContent = 'No categories yet.';
          return;
        }
        data.forEach(c => {
          const d = document.createElement('div');
          d.className = 'card';
          // make whole card clickable (link to nominated list for this category)
          const link = document.createElement('a');
          link.href = '/nominateds/view?category_id=' + encodeURIComponent(c.id);
          link.className = 'card-link';
          // title
          const h = document.createElement('h3');
          h.textContent = c.name;
          link.appendChild(h);
          // meta row
          const meta = document.createElement('div');
          meta.className = 'meta';
          // if user already voted in this category, show nominated name as a badge
          const votedNomId = votedMap[String(c.id)];
          if (votedNomId) {
            const nom = nominatedById[String(votedNomId)];
            const span = document.createElement('span');
            span.className = 'badge';
            span.textContent = nom ? 'You voted: ' + (nom.name || nom.movie_name) : 'You voted';
            meta.appendChild(span);
          } else {
            meta.textContent = 'Click to view nominees and vote';
          }
          link.appendChild(meta);
          d.appendChild(link);
          list.appendChild(d);
        });
      } catch (err) {
        el('msg').textContent = 'Error: ' + err.message;
      }
    }
    el('btnLogout').addEventListener('click', async () => {
      // call server logout to clear HttpOnly cookie
      await fetch('/logout', { method: 'GET', credentials: 'same-origin' });
      window.location.href = '/login/new';
    });

    // check if user is authenticated; show logout button only when authenticated
    (async function checkAuthAndShowLogout() {
      try {
        const res = await fetch('/me', { credentials: 'same-origin' });
        if (res.ok) {
          const btn = el('btnLogout');
          if (btn) btn.style.display = '';
        }
      } catch (e) {
        // ignore, leave logout hidden
      }
    })();

    fetchCategories();
  </script>
</body>
</html>
